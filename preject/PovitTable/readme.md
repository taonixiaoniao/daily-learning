# 事故碰撞分析表格思路及难点
antd 的表格有行合并的功能，针对每个单元格，可以赋予一个`rowSpan`值，`rowSpan`数值为多少，该单元格就会在表格中占据多少行高度，如果`rowSpan`为0，该单元格在表格中不显示（理解为宽高为0，下方的行往上缩进，右边的列往左缩进）。

利用这个行合并的功能，可以在视觉上达到“树状表格”的效果。

“树状表格”效果：表格第一列为树的顶层节点，后续的列为叶子节点；父节点展开后，该父节点在表格中高度等于其子节点高度总和。

## 一、 赋予每个节点（一个节点即表格中一个格子）展开/收起状态。
**问题**：表格数据是安装行渲染的，一行是一条数据，而“树状表格”父子节点是按照列排列的，如何做状态标记？
**解决**：表格的一列对应数据中一个字段，用该字段名拼接`Open`作为每一行中该列的标记，例如第一列对应的字段为`glbm`，则每行第一列（对应树的顶层）展开标记为`glbmOpen`。

## 二、 展开某节点数据处理。
在“树数据”接入组件时，克隆一份作为“源数据”使用。展开某节点时，从“源数据”中年递归取出该节点的叶子节点，将叶子节点插插入该节点的后面，并将该节点删除。这里直接使用`splice(index, 1, childData)`方法操作即可。

## 三、展开后构建rowSpan
分三两部分考虑
1. 被展开节点本身的处理
2. 被展开节点祖先受到的影响
3. 被展开节点后代收到的影响

### 被展开项处理
1. 被展开节点已被叶子节点替换，原来渲染在表格的父节点现在是其第一个叶子节点。表格中找到该“第一个叶子节点”，增加其`rowSpan`数值，该数值为被展开节点的叶子节点个数。对于剩下的叶子节点，要将其`rowSpan`设置为0.

### 对祖先的影响
1. 当被展开节点不在第一层时，展开后父节点节点的`rowSpan`数值也要变更。例如：第二层展开了某个节点，其叶子节点数量为3，该节点高度变为3，父节点高度相应也要增加。因此父节点`rowSpan`增加值为3 - 1 = 2，并且父节点所处层级的`rowSpan`数组要扩展，扩展量也是2。
**问题**：如何寻找该节点祖先节点
**解决**
2. 以此类推处理其所有祖先的`rowSpan`。

### 对后代的影响
1. 对被展开项直属后代的`rowSpan`处理在被展开项自身处理时已经做过了。
2. 对被展开项前置项的后代无影响
3. 当被展开项同级后置项的后代已经被展开，后代所处层级的`rowSpan`数组要变化。例如第三行第三列这个节点已经被展开（3个叶子节点），此时展开第二行第二列，此时第三行第三列的位置会向下平移3，因此第三列`rowSpan`数组应该插入一个`new Array(2).fill(undefined)`的数组。

## 四、收起某节点数据处理
在源数据中找到该节点本身，根据`rowSpan`找到该节点现在在表格中占据的行数，然后`splice(index, rowSpan, item)`

## 五、收起后构建rowSpan
类似展开的思路，收起节点也分三部分考虑
1. 被展开节点本身的处理
2. 被展开节点祖先受到的影响
3. 被展开节点后代收到的影响

### 被收起项处理
1. 被收起项此时在表格中只占据一个格子空间，因此其`rowSpan`设置为1或者`undefined`
2. 被收起项对应层级的`rowSpan`数组长度要缩减，缩减长度为被收起项之前的数值减一。缩减的位置应该从被收起项后面那一项开始。

### 对祖先的影响
祖先`rowSpan`数值减小，减小量为被收起项`rowSpan`数值减一；所处层级`rowSpan`数组长度缩减，缩减方式与被收起项相同。

### 对后代的影响
被收起项叶子节点已经全部被替换掉，可以理解为被收起项往后置层级格子都向上平移了，平移量就是收起项`rowSpan`数值减一。因此收起项后置层级的`rowSpan`数组长度都要缩减。

## 优化项
1. 数据量太大表格会卡，引入虚拟滚动
2. 原始数据存在data中，导致组件初始加载很慢
3. 递归找数据cloneDeep调用很多，影响性能

